document.addEventListener('DOMContentLoaded', () => {
    // 1. Core System Initialisation
    initCanvas();
    drawParticles();
    decryptText();
    initForensicStream();
    initScrollReveal();
    initMouseGlow();
    initGlitchSync();
    initNavEffects();
});

// --- 1. DYNAMIC NAV & SCROLL INTERACTIONS ---
function initNavEffects() {
    const nav = document.getElementById('main-nav');
    const progressBar = document.getElementById('scroll-progress');
    const sections = document.querySelectorAll('section'); 
    const navLinks = document.querySelectorAll('#main-nav a');

    window.addEventListener('scroll', () => {
        // 1. Scroll Progress Bar logic
        const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        const scrolled = (winScroll / height) * 100;
        if (progressBar) progressBar.style.width = scrolled + "%";

        // 2. Optimized Active Link Detection (ScrollSpy)
        let current = "";
        const scrollPosition = window.scrollY + 200; // Offset to detect section earlier

        sections.forEach((section) => {
            const sectionTop = section.offsetTop;
            const sectionHeight = section.clientHeight;
            
            if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
                current = section.getAttribute("id");
            }
        });

        navLinks.forEach((link) => {
            link.classList.remove("active-link");
            const href = link.getAttribute("href");
            // Highlight if link points to #timeline or other current section
            if (href && href.includes(current) && current !== "") {
                link.classList.add("active-link");
            }
        });

        // 3. Nav Shrink on scroll
        if (window.scrollY > 50) {
            nav.classList.add('nav-shrink');
        } else {
            nav.classList.remove('nav-shrink');
        }
    });
}

// --- 2. HIGH-SPEED SYSTEM BYPASS SEQUENCE ---
window.startBypassSequence = function() {
    const btnText = document.getElementById('btn-text');
    const progressBar = document.getElementById('progress-bar');
    const splash = document.getElementById('splash-screen');
    const main = document.getElementById('portfolio-main');
    const navName = document.getElementById('nav-operator-name');
    const logArea = document.getElementById('init-logs');
    const logScroll = document.getElementById('log-scroll');

    if (btnText) btnText.innerText = "AUTHENTICATING...";
    if (progressBar) progressBar.style.width = "100%";
    if (logArea) logArea.classList.remove('hidden');

    const logs = [
        "ESTABLISHING_UPLINK...",
        "NODE_IDENTIFIED: EDINBURGH_SERVER",
        "BYPASSING_FIREWALL...",
        "CRACKING_HASH_0xAF44...",
        "BIO_METRIC_SCAN: MATCHED",
        "ACCESS_GRANTED: WELCOME_OPERATOR"
    ];

    logs.forEach((msg, i) => {
        setTimeout(() => {
            if (logScroll) {
                const p = document.createElement('p');
                p.innerText = `> ${msg}`;
                logScroll.prepend(p);
            }
            if(msg.includes("GRANTED") && splash) {
                splash.style.animation = "shake 0.3s cubic-bezier(.36,.07,.19,.97) both";
            }
        }, i * 100); // High-speed log print
    });

    setTimeout(() => {
        if (splash) splash.classList.add('vault-open');
        if (main) {
            main.classList.remove('opacity-0', 'invisible');
            main.classList.add('opacity-100');
            if (navName) setTimeout(() => navName.classList.add('name-cycle'), 200);
        }
        setTimeout(() => {
            if (splash) splash.style.display = 'none';
            document.body.style.overflow = 'auto';
        }, 400); 
    }, 1100); // 1.1s Final Reveal
};

// --- 3. PROJECT MODAL SYSTEM (FIXED) ---
const modal = document.getElementById('project-modal');
const mTitle = document.getElementById('m-title');
const mId = document.getElementById('m-id');
const mStatus = document.getElementById('m-status');
const mDesc = document.getElementById('m-desc');
const mStack = document.getElementById('m-stack');
const mFeatures = document.getElementById('m-features');
const mLink = document.getElementById('m-link');

/**
 * FIXED: Uses data-attributes that match index.html for reliable opening.
 * @param {HTMLElement} card - The project card element.
 */
function openProjectModal(card) {
    // Read attributes (Ensure these match your index.html exactly)
    const id = card.getAttribute('data-id');
    const colorClass = card.getAttribute('data-color');
    const status = card.getAttribute('data-status');
    const title = card.getAttribute('data-title');
    const desc = card.getAttribute('data-description');
    const stack = card.getAttribute('data-stack') ? card.getAttribute('data-stack').split(',') : [];
    const features = card.getAttribute('data-features') ? card.getAttribute('data-features').split('|') : [];
    const link = card.getAttribute('data-link');

    // Populate Modal Header
    mId.innerText = id;
    mId.className = `text-xs mono font-bold tracking-widest uppercase ${colorClass}`;
    mTitle.innerText = title;
    mDesc.innerText = desc;
    mLink.href = link || "#";

    // Populate Status
    mStatus.innerText = status;
    mStatus.className = status === 'COMPLETE' 
        ? "text-[10px] mono border border-green-500/50 px-2 py-1 text-green-500 rounded-sm uppercase"
        : "text-[10px] mono border border-amber-500/50 px-2 py-1 text-amber-500 rounded-sm uppercase";

    // Populate Tech Stack Tags
    mStack.innerHTML = '';
    stack.forEach(tech => {
        const span = document.createElement('span');
        span.className = 'modal-stack-tag';
        span.innerText = tech.trim();
        mStack.appendChild(span);
    });

    // Populate Key Objectives
    mFeatures.innerHTML = '';
    features.forEach(f => {
        const li = document.createElement('li');
        li.className = 'feature-item';
        li.innerText = f.trim();
        mFeatures.appendChild(li);
    });

    // Animate Modal Open
    modal.classList.remove('hidden');
    setTimeout(() => modal.classList.add('modal-active'), 10);
    document.body.style.overflow = 'hidden';
}

function closeProjectModal() {
    modal.classList.remove('modal-active');
    document.body.style.overflow = 'auto';
    setTimeout(() => modal.classList.add('hidden'), 300);
}

// --- 4. CORE ENGINE & VISUALS ---
function initGlitchSync() {
    const authBtn = document.getElementById('auth-trigger');
    const decryptName = document.getElementById('decrypt-name');
    if (authBtn && decryptName) {
        authBtn.addEventListener('mouseenter', () => {
            decryptName.classList.add('glitch-active');
            decryptName.style.animationDuration = '0.2s';
        });
        authBtn.addEventListener('mouseleave', () => {
            decryptName.classList.remove('glitch-active');
            decryptName.style.animationDuration = '5s';
        });
    }
}

function initForensicStream() {
    const monitor = document.getElementById('forensic-monitor');
    const actions = ["PACKET_INSPECT", "MEM_DUMP", "HEX_READ", "VOLATILITY_SCAN"];
    const targets = ["192.168.1.104", "SYS_KERNEL_64", "ETH0_UPLINK"];

    setInterval(() => {
        if (monitor) {
            const p = document.createElement('p');
            const timestamp = new Date().toLocaleTimeString().split(' ')[0];
            const randAction = actions[Math.floor(Math.random() * actions.length)];
            const randTarget = targets[Math.floor(Math.random() * targets.length)];
            const hex = Math.random().toString(16).slice(2, 8).toUpperCase();

            p.innerText = `[${timestamp}] ${randAction} >> ${randTarget} :: 0x${hex}`;
            monitor.prepend(p);
            if (monitor.children.length > 15) monitor.lastChild.remove();
        }
    }, 800);
}

function decryptText() {
    const el = document.getElementById('decrypt-name');
    const target = "Ahmed K."; 
    const chars = "01ABCDEFGH!@#$%^&*";
    let iteration = 0;

    const interval = setInterval(() => {
        if (!el) return;
        el.innerText = target.split("").map((c, i) => {
            if (i < iteration) return target[i];
            return chars[Math.floor(Math.random() * chars.length)];
        }).join("");
        if (iteration >= target.length) {
            clearInterval(interval);
            el.classList.add('name-cycle');
        }
        iteration += 1 / 3;
    }, 40);
}

// --- 5. NETWORK PARTICLE BACKGROUND ---
const canvas = document.getElementById('threat-map');
const ctx = canvas.getContext('2d');
let particles = [];

function initCanvas() {
    if (!canvas) return;
    canvas.width = window.innerWidth; 
    canvas.height = window.innerHeight;
    particles = [];
    for (let i = 0; i < 60; i++) {
        particles.push({
            x: Math.random() * canvas.width, 
            y: Math.random() * canvas.height,
            vx: (Math.random() - 0.5) * 0.4, 
            vy: (Math.random() - 0.5) * 0.4
        });
    }
}

function drawParticles() {
    if (!ctx) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = '#00ff41';
    ctx.lineWidth = 0.5;

    particles.forEach(p => {
        p.x += p.vx; p.y += p.vy;
        if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
        if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
        ctx.beginPath(); ctx.arc(p.x, p.y, 1, 0, Math.PI * 2); ctx.stroke();
        particles.forEach(p2 => {
            let dist = Math.hypot(p.x - p2.x, p.y - p2.y);
            if (dist < 150) {
                ctx.globalAlpha = 1 - (dist / 150);
                ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
            }
        });
    });
    requestAnimationFrame(drawParticles);
}

function initMouseGlow() {
    const glow = document.getElementById('mouse-glow');
    window.addEventListener('mousemove', (e) => {
        if (glow) {
            glow.style.left = e.clientX - 300 + 'px';
            glow.style.top = e.clientY - 300 + 'px';
        }
    });
}

function initScrollReveal() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) entry.target.classList.add('active');
        });
    }, { threshold: 0.15 });
    document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
}

window.addEventListener('resize', initCanvas);
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.classList.contains('modal-active')) closeProjectModal();
});
